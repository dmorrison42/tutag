@page "/counter"
@inject IVoteService VoteService
@inject IUserService UserService
@inject ITurnService TurnService

<AuthorizeView>
    <Authorized>
        <h1>Counter</h1>
        <div class="alert alert-secondary mt-4" role="alert">
            <span class="oi oi-person mr-2" aria-hidden="true"></span>
            <span>
                You are connected as
                <b>@UserService.CurrentUser?.Username</b>
                Room Code
                <i>@UserService.CurrentUser?.RoomCode</i>
                <i>@(UserService.CurrentUser?.IsAdmin == true ? "[Admin]" :"")</i>
            </span>
        </div>
        <div class="alert alert-secondary mt-4" role="alert">
            @TurnService.CurrentTurn?.Prompt
            @if (UserService.CurrentUser?.IsAdmin == true)
                {
                    <textarea class="input-lg" placeholder="enter your comment" @bind="_newPrompt" @bind:event="oninput"
                        @onkeyup="ProcessKey(TurnAsync)"></textarea>
                    <button class="btn btn-default" @onclick="@(() => TurnAsync())">Send</button>
                }
                </div>

                @foreach (var action in Actions)
            {
                <Vote Message="@action.Description" OnChange="@(v => Vote(action.Id,v))"
                    Value="@VoteService.GetMyVote(action.Id)" Total="@VoteService.CountVotes(action.Id)"></Vote>
            }

                @if (UserService.CurrentUser?.IsAdmin == true)
            {
                <textarea class="input-lg" placeholder="enter your comment" @bind="_newMessage" @bind:event="oninput"
                    @onkeyup="ProcessKey(SendAsync)"></textarea>
                <button class="btn btn-default" @onclick="@(() => SendAsync())">Send</button>
            }
            </Authorized>
            <NotAuthorized>
                <Login></Login>
            </NotAuthorized>
        </AuthorizeView>

        @code {
    private string _newMessage = "";
    private string _newPrompt = "";

    private void Vote(int actionId, int value)
    {
        VoteService.CastVote(actionId, value);
    }

    private IEnumerable<Models.Action> Actions => VoteService.Actions
        .OrderByDescending(v => VoteService.CountVotes(v.Id));

    protected override void OnInitialized()
    {
        VoteService.OnUpdate += (o, e) =>
        {
            InvokeAsync(StateHasChanged);
        };
        TurnService.OnUpdate += (o, e) =>
        {
            InvokeAsync(StateHasChanged);
        };
    }

    private async Task SendAsync()
    {
        var buffer = _newMessage;
        _newMessage = null;
        await Task.Run(() =>
        {
            VoteService.CreateAction(buffer);
        });
    }

    private async Task TurnAsync()
    {
        var buffer = _newPrompt;
        _newPrompt = null;
        await Task.Run(() =>
        {
            TurnService.CreateTurn(buffer);
        });
    }

    public Func<KeyboardEventArgs, Task> ProcessKey(Func<Task> action)
    {
        return async (e) =>
        {
            if (!e.ShiftKey && e.Key == "Enter")
            {
                await action();
            }
        };
    }
}
